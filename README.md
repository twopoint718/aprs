README
===

The overall goal of this project is to create an APRS beacon device using the [HamWing carrier board](https://github.com/W8LID/HamWing) by [W8LID](https://twitter.com/w8lid).

To do this, this project implements an AFSK "modem" via a low-pass filtered PWM signal.
I'm using an [Adafruit Feather RP2040 board](https://learn.adafruit.com/adafruit-feather-rp2040-pico) as the microcontroller in this project.
The sine wave is created by applying PWM output to a 3.1 kHz low-pass filter.
Via software it is able to produce 2-FSK at 1200 bps using [Bell 202](https://en.wikipedia.org/wiki/Bell_202_modem) (-ish) 1200 Hz/2200 Hz tones.

Definitions & Concepts
---

- **Sampling period**
  The voltage generated by the PWM wave in the interval between two interrupts will be a constant value and this time period can be called _sampling period_.
- **PWM cycle**
  The _duty cycle_ of the PWM, this is equivalent to the PWM off time + PWM on time.
  There will be many PWM cycles per sampling period.

The duty cycle of the PWM is increased in a sinusoidal way (e.g. 5%, 10%, 25%, etc.) at each sampling time (timer interrupt/callback).

Equations and variables
---

The RP2040 has a built-in PWM peripheral that uses the system clock at full speed (no dividers).
This yields about 125 MHz to work with.
The PWM peripheral is controlled by two variables:

`COUNTER_TOP` 16-bit value that controls when the auto-incrementing counter rolls over. The PWM frequency then is given by:

$$ f_{pwm} = \frac{f_{sys}}{COUNTER\_TOP + 1} $$

Note: If you look at the datasheet, I'm not using phase-correct PWM nor am I using any divisors, so other values in the denominator are 1.

`pwm_level` is the duty cycle of the PWM signal.
When the auto-incrementing counter reaches `pwm_level`, the PWM output goes low.
`pwm_level` is scaled to `COUNTER_TOP`, so that `COUNTER_TOP/2` yields a 50% duty cycle.

`wav` is a table of 256 8-bit samples of an ideal sine wave.
This is what will make up our actual output signal.

Now we have to deal with generating the audio signal.
This involves choosing a periodic interrupt that will set the correct sampling period mentioned above.
We have 256 samples for our sine wave.
The higher frequency in Bell 202 is _space_ (as in [mark and space](https://en.wikipedia.org/wiki/Mark_and_space)) and it is 2,200 Hz.
We have to "play back" 256 samples per cycle, which happens 2,200 times per second.
If $x$ is the sampling period then:

$$ 2200 Hz = \frac{1}{256x} $$
$$ x \approx 1.7 \mu s $$

Our interrupt should happen every 1.7 microseconds or so.

References
---
1. [How to Generate Sine Wave using PWM with PIC Microcontroller](https://www.engineersgarage.com/how-to-generate-sine-wave-using-pwm-with-pic-microcontroller-part-19-25/)
